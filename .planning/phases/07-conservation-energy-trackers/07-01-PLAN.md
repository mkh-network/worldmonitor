---
phase: 07-conservation-energy-trackers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/conservation-wins.json
  - src/services/conservation-data.ts
  - src/components/SpeciesComebackPanel.ts
autonomous: true
requirements:
  - SPECIES-01
  - SPECIES-02
  - SPECIES-03

must_haves:
  truths:
    - "Species comeback cards display a species photo, population trend sparkline, and recovery status badge"
    - "Conservation data contains 10 species with historical population timeline data from published sources"
    - "Each species card shows the population growth narrative with source citation"
  artifacts:
    - path: "src/data/conservation-wins.json"
      provides: "Curated dataset of 10 conservation success species with population timelines"
      contains: "Bald Eagle"
    - path: "src/services/conservation-data.ts"
      provides: "SpeciesRecovery interface and fetchConservationWins() loader"
      exports: ["SpeciesRecovery", "fetchConservationWins"]
    - path: "src/components/SpeciesComebackPanel.ts"
      provides: "Panel subclass rendering species cards with D3 sparklines"
      exports: ["SpeciesComebackPanel"]
  key_links:
    - from: "src/components/SpeciesComebackPanel.ts"
      to: "src/services/conservation-data.ts"
      via: "import SpeciesRecovery type for setData()"
      pattern: "import.*conservation-data"
    - from: "src/services/conservation-data.ts"
      to: "src/data/conservation-wins.json"
      via: "dynamic import of static JSON"
      pattern: "import.*conservation-wins"
---

<objective>
Build the species comeback panel: a curated static JSON dataset of 10 conservation success stories with population timeline data, a data service to load it, and a SpeciesComebackPanel component that renders cards with species photo, D3 sparkline, and recovery status badge.

Purpose: SPECIES-01 (card display), SPECIES-02 (IUCN/conservation report data), SPECIES-03 (historical population trends). The IUCN Red List API lacks population count time-series, so a curated static JSON is the correct approach (per research findings).

Output: conservation-wins.json, conservation-data.ts service, SpeciesComebackPanel.ts component
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-conservation-energy-trackers/07-RESEARCH.md
@src/services/humanity-counters.ts — Pattern for static data service (hardcoded data, typed interface, exported loader)
@src/services/progress-data.ts — ProgressDataPoint type reuse for sparkline data points
@src/components/ProgressChartsPanel.ts — D3 sparkline pattern (d3.line, d3.area, curveMonotoneX, getCSSColor)
@src/components/CountersPanel.ts — Panel subclass pattern (extends Panel, constructor with id/title, public setData, destroy)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conservation-wins.json and conservation-data.ts service</name>
  <files>
    src/data/conservation-wins.json
    src/services/conservation-data.ts
  </files>
  <action>
**Create `src/data/conservation-wins.json`** — a curated JSON array of 10 species with verified population recovery data from published conservation reports.

Each entry in the JSON array must have these fields:
- `id` (string): lowercase-hyphenated slug (e.g., "bald-eagle")
- `commonName` (string): English common name
- `scientificName` (string): Latin binomial
- `photoUrl` (string): Wikimedia Commons URL for species photo (use `upload.wikimedia.org/wikipedia/commons/thumb/` URLs for stability)
- `iucnCategory` (string): Current IUCN Red List category code — one of: "LC", "NT", "VU", "EN", "CR"
- `populationTrend` (string): "increasing" | "stable"
- `recoveryStatus` (string): "recovered" | "recovering" | "stabilized"
- `populationData` (array): Array of `{year: number, value: number}` objects (minimum 3 data points per species, ideally 4-6 spanning decades)
- `summaryText` (string): 1-2 sentence narrative of the recovery story
- `source` (string): Citation for the population data (e.g., "USFWS 2020 Survey")
- `region` (string): Geographic region (e.g., "North America", "Global", "East Africa")
- `lastUpdated` (string): ISO date string of data compilation (use "2024-01-15")

**The 10 species (from research):**

1. Bald Eagle — 417 pairs (1963) → 9,789 pairs (2006) → 71,400 pairs (2020). LC. Recovered. USFWS.
2. Humpback Whale — 5,000 (1966) → 25,000 (1990) → 84,000 (2024). LC. Recovered. NOAA/IWC.
3. Giant Panda — 1,114 (1988) → 1,596 (2004) → 1,864 (2014). VU. Recovering. WWF/China Gov.
4. Southern White Rhino — 50 (1900) → 11,670 (2007) → 16,800 (2024). NT. Recovering. IUCN AfRSG.
5. Gray Wolf (US lower 48) — 1,000 (1974) → 3,020 (2003) → 6,100 (2023). LC. Recovered. USFWS.
6. Peregrine Falcon — 324 pairs (1975) → 1,650 pairs (1999) → 3,000 pairs (2015). LC. Recovered. TPC.
7. American Alligator — 100,000 (1967) → 1,000,000 (1987) → 5,000,000 (2024). LC. Recovered. USFWS.
8. Arabian Oryx — 0 (1972) → 500 (1998) → 1,220 (2023). VU. Recovering. EAD/IUCN.
9. California Condor — 22 (1982) → 170 (2003) → 561 (2024). CR. Recovering. USFWS.
10. Mountain Gorilla — 254 (1981) → 480 (2010) → 1,063 (2021). EN. Recovering. GVTC.

For photoUrl, use stable Wikimedia Commons thumb URLs. Example pattern:
`https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Bald_Eagle_Portrait.jpg/400px-Bald_Eagle_Portrait.jpg`
Find real Wikimedia Commons image URLs for each species. Use 400px thumb width.

**Create `src/services/conservation-data.ts`** — a typed service module following the humanity-counters.ts pattern:

```typescript
export interface SpeciesRecovery {
  id: string;
  commonName: string;
  scientificName: string;
  photoUrl: string;
  iucnCategory: string;
  populationTrend: 'increasing' | 'stable';
  recoveryStatus: 'recovered' | 'recovering' | 'stabilized';
  populationData: Array<{ year: number; value: number }>;
  summaryText: string;
  source: string;
  region: string;
  lastUpdated: string;
}

/**
 * Load curated conservation wins from static JSON.
 * Uses dynamic import for code-splitting (JSON only loaded for happy variant).
 */
export async function fetchConservationWins(): Promise<SpeciesRecovery[]> {
  const { default: data } = await import('@/data/conservation-wins.json');
  return data as SpeciesRecovery[];
}
```

Add a file-level doc comment explaining: curated dataset compiled from published conservation reports because IUCN Red List API lacks population count time-series. Monthly refresh cadence via JSON update.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify conservation-wins.json is valid JSON with 10 entries. Verify each entry has all required fields and at least 3 populationData points.
  </verify>
  <done>
conservation-wins.json contains 10 species with typed population timeline data. conservation-data.ts exports SpeciesRecovery type and fetchConservationWins() loader. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SpeciesComebackPanel component with D3 sparklines</name>
  <files>src/components/SpeciesComebackPanel.ts</files>
  <action>
Create `src/components/SpeciesComebackPanel.ts` — a Panel subclass rendering species conservation win cards.

**Structure:** Follow ProgressChartsPanel pattern (extends Panel, setData method, D3 rendering, getCSSColor for theme-aware colors).

```typescript
import { Panel } from './Panel';
import * as d3 from 'd3';
import type { SpeciesRecovery } from '@/services/conservation-data';
import { getCSSColor } from '@/utils';
import { replaceChildren } from '@/utils/dom-utils';
```

**Constructor:**
```typescript
constructor() {
  super({ id: 'species', title: 'Conservation Wins', trackActivity: false });
}
```

**Public API:**
- `setData(species: SpeciesRecovery[]): void` — clears content, renders species cards
- `destroy(): void` — cleanup, call super.destroy()

**Card Rendering (in setData):**

For each species in the array, create a card element (`div.species-card`) containing:

1. **Photo section** (`div.species-photo`):
   - `<img>` with `src=species.photoUrl`, `alt=species.commonName`
   - `onerror` fallback: set `src` to a data URI SVG placeholder (simple green leaf/animal silhouette). Use inline `this.onerror=null;this.src='data:image/svg+xml,...'` pattern to prevent infinite loop.
   - `loading="lazy"` attribute for performance

2. **Info section** (`div.species-info`):
   - `<h4 class="species-name">` with commonName
   - `<span class="species-scientific">` with scientificName in italics
   - `<div class="species-badges">` containing:
     - Recovery status badge (`span.species-badge.badge-{recoveryStatus}`) — text: "Recovered", "Recovering", or "Stabilized"
     - IUCN category badge (`span.species-badge.badge-iucn`) — text: the iucnCategory code (LC, VU, EN, CR, NT)
   - Region text (`span.species-region`) — e.g., "North America"

3. **Sparkline section** (`div.species-sparkline`):
   - An SVG element rendered by D3 showing the population trend
   - SVG dimensions: width = card width (use 100% via viewBox), height = 50px
   - Use `d3.area()` with `curveMonotoneX` for the filled area (matching ProgressChartsPanel pattern)
   - Use `d3.line()` with `curveMonotoneX` for the stroke line on top
   - Color: use `getCSSColor('--green')` for area fill (opacity 0.2) and line stroke
   - X scale: `d3.scaleLinear()` domain from min year to max year
   - Y scale: `d3.scaleLinear()` domain from 0 to max population value (with 10% padding)
   - Add start and end labels: first year value and latest year value as text annotations
   - Small margins: top=4, right=8, bottom=16, left=8

4. **Summary section** (`div.species-summary`):
   - `<p>` with summaryText
   - `<cite class="species-source">` with source text

**Card container:** Wrap all cards in a `div.species-grid` that will be styled by CSS in plan 07-03.

**Empty state:** If species array is empty, show `<div class="species-empty">No conservation data available</div>`.

**Photo error handling:** Each `<img>` element must have an `onerror` handler that replaces the broken image with a nature-themed SVG placeholder. Use this pattern:
```typescript
img.onerror = () => {
  img.onerror = null; // prevent infinite loop
  img.src = 'data:image/svg+xml,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300" fill="%236B8F5E"><rect width="400" height="300" fill="%23f0f4ed"/><text x="200" y="150" text-anchor="middle" font-size="48">\uD83C\uDF3F</text></svg>'
  );
};
```

**D3 sparkline rendering function** — create a private method `renderSparkline(container: HTMLDivElement, data: Array<{year: number; value: number}>, color: string)`:
- Create an SVG via `d3.select(container).append('svg')` with viewBox for responsive sizing
- Use the same area + line pattern from ProgressChartsPanel
- Add text labels for the first and last data points (year + formatted value)
- Format population values with Intl.NumberFormat for readability (e.g., "71,400")
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify the file exports SpeciesComebackPanel class. Verify it extends Panel, has setData() and destroy() methods.
  </verify>
  <done>
SpeciesComebackPanel renders species cards with photo (with onerror fallback), D3 sparkline showing population trend, recovery status badge, IUCN category badge, and source citation. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. conservation-wins.json has exactly 10 entries, each with all required fields
3. Each species has at least 3 populationData points spanning multiple decades
4. SpeciesComebackPanel extends Panel and exports correctly
5. Photo onerror fallback prevents broken images
</verification>

<success_criteria>
- conservation-wins.json contains 10 well-documented species with population timelines from published conservation reports
- conservation-data.ts exports typed SpeciesRecovery interface and async fetchConservationWins() loader
- SpeciesComebackPanel renders cards with photo, D3 sparkline, badges, and summary
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-conservation-energy-trackers/07-01-SUMMARY.md`
</output>
