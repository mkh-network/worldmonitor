---
phase: 07-conservation-energy-trackers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/renewable-energy-data.ts
  - src/components/RenewableEnergyPanel.ts
autonomous: true
requirements:
  - ENERGY-01
  - ENERGY-02
  - ENERGY-03

must_haves:
  truths:
    - "A renewable energy panel visualizes global renewable electricity percentage with a D3 arc gauge"
    - "The gauge animates from 0 to the actual percentage with a smooth climbing effect"
    - "Regional breakdown shows renewable percentages for major world regions"
    - "Data is sourced from World Bank indicators via the existing getIndicatorData() RPC"
  artifacts:
    - path: "src/services/renewable-energy-data.ts"
      provides: "Renewable energy data fetching from World Bank API"
      exports: ["RenewableEnergyData", "fetchRenewableEnergyData"]
    - path: "src/components/RenewableEnergyPanel.ts"
      provides: "Panel subclass with D3 arc gauge and regional breakdown"
      exports: ["RenewableEnergyPanel"]
  key_links:
    - from: "src/services/renewable-energy-data.ts"
      to: "src/services/economic/index.ts"
      via: "getIndicatorData() RPC for World Bank data"
      pattern: "import.*getIndicatorData.*economic"
    - from: "src/components/RenewableEnergyPanel.ts"
      to: "src/services/renewable-energy-data.ts"
      via: "import types for setData()"
      pattern: "import.*renewable-energy-data"
---

<objective>
Build the renewable energy tracker panel: a data service fetching World Bank renewable energy indicators via the existing getIndicatorData() RPC, and a RenewableEnergyPanel component with an animated D3 arc gauge showing global renewable percentage plus a regional breakdown table.

Purpose: ENERGY-01 (renewable capacity visualization), ENERGY-02 (animated gauge with regional breakdown), ENERGY-03 (IEA-sourced data via World Bank proxy). No IEA direct API needed — World Bank SE4ALL indicators are sourced FROM IEA data.

Output: renewable-energy-data.ts service, RenewableEnergyPanel.ts component
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-conservation-energy-trackers/07-RESEARCH.md
@src/services/progress-data.ts — Proven pattern for fetching World Bank indicators via getIndicatorData() RPC
@src/components/ProgressChartsPanel.ts — D3 charting pattern (d3.arc, getCSSColor, Panel lifecycle)
@src/components/CountersPanel.ts — Panel subclass pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create renewable-energy-data.ts service</name>
  <files>src/services/renewable-energy-data.ts</files>
  <action>
Create `src/services/renewable-energy-data.ts` — a data service following the exact same pattern as `src/services/progress-data.ts`.

**Imports:**
```typescript
import { getIndicatorData } from '@/services/economic';
```

**Types:**

```typescript
export interface RegionRenewableData {
  code: string;       // World Bank region code (e.g., "1W", "EAS")
  name: string;       // Human-readable name (e.g., "World", "East Asia & Pacific")
  percentage: number;  // Latest renewable electricity % value
  year: number;       // Year of latest data point
}

export interface RenewableEnergyData {
  globalPercentage: number;          // Latest global renewable electricity %
  globalYear: number;                // Year of latest global data
  historicalData: Array<{ year: number; value: number }>;  // Global time-series
  regions: RegionRenewableData[];    // Regional breakdown
}
```

**Constants:**

```typescript
// World Bank indicator for renewable electricity output as % of total
const INDICATOR_CODE = 'EG.ELC.RNEW.ZS';

// World Bank region codes for breakdown
const REGIONS: Array<{ code: string; name: string }> = [
  { code: '1W', name: 'World' },
  { code: 'EAS', name: 'East Asia & Pacific' },
  { code: 'ECS', name: 'Europe & Central Asia' },
  { code: 'LCN', name: 'Latin America & Caribbean' },
  { code: 'MEA', name: 'Middle East & N. Africa' },
  { code: 'NAC', name: 'North America' },
  { code: 'SAS', name: 'South Asia' },
  { code: 'SSF', name: 'Sub-Saharan Africa' },
];
```

**Fetch function:**

```typescript
export async function fetchRenewableEnergyData(): Promise<RenewableEnergyData> {
  // ... implementation
}
```

Implementation pattern (copy from progress-data.ts):
1. Fetch the indicator for ALL region codes in a single `getIndicatorData()` call by passing all region codes in `countries` array: `getIndicatorData(INDICATOR_CODE, { countries: REGIONS.map(r => r.code), years: 35 })`
2. Extract the "1W" (World) data for the global percentage and historical time-series:
   - Filter out null/NaN values (same as progress-data.ts)
   - Sort by year ascending
   - Latest value = last element's value, latest year = last element's year
3. For each region, extract the latest available data point:
   - Get `response.byCountry[regionCode]`
   - Find the most recent non-null value
   - Create a `RegionRenewableData` entry
4. Filter out the "World" entry from regions array (it's in globalPercentage already)
5. Sort regions by percentage descending (highest renewable % first)

**Graceful degradation:**
- Wrap entire function in try/catch
- On failure, return a default with `globalPercentage: 0, globalYear: 0, historicalData: [], regions: []`
- Individual region failures: skip that region (don't crash the whole fetch)

Add a file-level doc comment explaining: World Bank indicator EG.ELC.RNEW.ZS is sourced FROM IEA Energy Statistics (per research), so this fulfills ENERGY-03 requirement for IEA data without needing IEA's paid API.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify the file exports RenewableEnergyData, RegionRenewableData types and fetchRenewableEnergyData() function.
  </verify>
  <done>
renewable-energy-data.ts fetches World Bank renewable electricity indicator for global + 7 regions, returns typed data with global percentage, historical time-series, and regional breakdown. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RenewableEnergyPanel with D3 arc gauge and regional breakdown</name>
  <files>src/components/RenewableEnergyPanel.ts</files>
  <action>
Create `src/components/RenewableEnergyPanel.ts` — a Panel subclass with an animated D3 arc gauge and regional breakdown.

**Imports:**
```typescript
import { Panel } from './Panel';
import * as d3 from 'd3';
import type { RenewableEnergyData, RegionRenewableData } from '@/services/renewable-energy-data';
import { getCSSColor } from '@/utils';
import { replaceChildren } from '@/utils/dom-utils';
```

**Constructor:**
```typescript
constructor() {
  super({ id: 'renewable', title: 'Renewable Energy', trackActivity: false });
}
```

**Public API:**
- `setData(data: RenewableEnergyData): void` — clears content, renders gauge + regions
- `destroy(): void` — cleanup, call super.destroy()

**Layout (in setData):**

Create a `div.renewable-container` with two sections:

**Section 1: Gauge (`div.renewable-gauge-section`)**

Build an animated D3 arc gauge showing global renewable electricity percentage:

- SVG element with viewBox for responsive sizing (e.g., viewBox="0 0 200 200")
- Use `d3.arc()` with `innerRadius(radius * 0.7)` and `outerRadius(radius)` and `cornerRadius(4)`
- **Background arc** (full circle): `endAngle: Math.PI * 2`, fill with `getCSSColor('--border')` for theme-aware track color
- **Foreground arc** (renewable %): animate from 0 to `(percentage / 100) * Math.PI * 2` using `d3.transition()` with `duration(1500)` and `d3.easeCubicOut`
- Foreground fill: `getCSSColor('--green')` (sage green from happy theme)
- **Center text:** Two lines centered in the donut:
  - Large number: `${globalPercentage.toFixed(1)}%` (class `gauge-value`)
  - Small label: "Renewable" (class `gauge-label`)
- **Data year label:** Below the gauge: "Data from {globalYear}" (class `gauge-year`)

D3 animation pattern for the arc (from research):
```typescript
const interpolate = d3.interpolate(0, (percentage / 100) * Math.PI * 2);
foreground.transition()
  .duration(1500)
  .ease(d3.easeCubicOut)
  .attrTween('d', () => (t: number) => arc({ endAngle: interpolate(t) } as any) as string);
```

**Section 2: Regional Breakdown (`div.renewable-regions`)**

A compact list/table showing each region's renewable percentage:

For each region in `data.regions` (sorted by percentage descending):
- Create a `div.region-row` containing:
  - `span.region-name` — region name text
  - `div.region-bar-container` — a horizontal bar chart element:
    - `div.region-bar` — width set to `${percentage}%`, background `getCSSColor('--green')` with opacity varying by rank (first = 1.0, fading to 0.5)
  - `span.region-value` — `${percentage.toFixed(1)}%`

**Empty state:** If globalPercentage is 0 and regions is empty: `<div class="renewable-empty">No renewable energy data available</div>`

**Historical sparkline (bonus below gauge):** If `data.historicalData.length > 2`, render a small D3 area chart below the gauge showing the global renewable % trend over time. Use the same d3.area() + d3.line() + curveMonotoneX pattern from ProgressChartsPanel. Height: 40px. Color: getCSSColor('--green'). This shows the "climbing" trend visually.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify the file exports RenewableEnergyPanel class. Verify it extends Panel, has setData() and destroy() methods.
  </verify>
  <done>
RenewableEnergyPanel renders an animated D3 arc gauge showing global renewable electricity percentage, a historical trend sparkline, and a regional breakdown with horizontal bars. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. renewable-energy-data.ts fetches World Bank data using existing getIndicatorData() RPC
3. RenewableEnergyPanel extends Panel with animated gauge and regional breakdown
4. D3 arc animation uses easeCubicOut for smooth climbing effect
5. All colors use getCSSColor() for theme-aware rendering
</verification>

<success_criteria>
- renewable-energy-data.ts fetches global + regional renewable electricity percentages from World Bank via existing RPC
- RenewableEnergyPanel displays animated D3 arc gauge, historical trend sparkline, and regional breakdown bars
- Gauge animates from 0 to actual percentage with 1.5s ease-out transition
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-conservation-energy-trackers/07-02-SUMMARY.md`
</output>
